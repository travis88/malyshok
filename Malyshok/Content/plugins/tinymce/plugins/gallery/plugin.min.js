tinymce.PluginManager.add('gallery', function (editor, url) {

    var _url = "/admin/photoalbums/api";
    var _size = 30;
    var _page = 1;
    var items = [];

    function dateFormat(jsonDateTimestamp) {

        //var jsonDateTimestamp = "/Date(25200000)/"
        var d = eval("new " + jsonDateTimestamp.substring(1, jsonDateTimestamp.length - 1));

       // var d = new Date(timestamp);
        var month = d.getMonth() + 1;
        var day = d.getDate();

        var formatted = (day < 10 ? '0' : '') + day + '.'
                    + (month < 10 ? '0' : '') + month + '.'
                    + d.getFullYear();

        return formatted;
    };


    // Add a button that opens a window
    editor.addButton('gallery', {
        //text: 'Галерея',
        icon: 'gallery',
        onclick: function () {
            items = [];

            var params = {
                page: _page,
                size: _size
            };

            $.ajax({
                url: _url,
                method: "POST",
                async: false,
                cache: false,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(params)
            })
                .done(function (obj) {
                    if (obj.Data != null)
                    {
                        $.each(obj.Data, function (key, value) {

                            items.push({
                                type: 'button',
                                name: 'mce-gallery-plugin-insert-btn',
                                text: 'Insert',
                                title: 'Вставить фотоальбом',
                                value: value.Id,
                                classes: 'gallery-plugin-item-insert-btn button icon-flow-tree',
                                onclick: function (e) {

                                    var _src = "/Photolist/" + value.Id;
                                    var w = "100%";
                                    var h = "150";
                                    var cl = "photo-gallery";
                                    var iframe = '<iframe src="' + _src + '" width="' + w + '" height="' + h + '" class="' + cl + '"></iframe>'
                                    editor.insertContent(iframe);
                                    editor.windowManager.close();
                                }
                            });
                            items.push({
                                type: 'container',
                                classes: 'gallery-plugin-item',
                                html: "<div class='mce-gallery-plugin-item-img'>"
                                            + "<img src='" + value.PreviewImage.Url + "' title='" + value.Title + "'>"
                                        + "</div>"
                                            
                                        + "<div class='mce-gallery-plugin-item-block'>"
                                            + "<div class='mce-gallery-plugin-item-date'>" + dateFormat(value.Date) + "</div>"
                                            + "<div class='mce-gallery-plugin-item-title'>" + value.Title + "</div>"
                                            + "<div class='mce-gallery-plugin-item-text'>" + ((value.Text)? value.Text:"") + "</div>"
                                         + "</div>"
                            });

                            items.push({
                                type: 'container',
                                classes: 'gallery-plugin-item-borderbottom',
                                html: ""
                            });

                        });
                    }
                    else {
                        items.push( 
                            {
                                type: "container",
                                html: "<div class='alert alert-info'>В галерее нет ни одного фотоальбома</div>"
                            });
                    }
                })
                .fail(function (jqXHR, status) {
                    console.log("Ошибка" + " " + status + " " + jqXHR);
                    items.push({
                        type: 'container',
                        html: "<div class='alert alert-danger'>Произошла ошибка</div>"
                    });
                })
                .always(function (response) {
                    //Если понадобится пейджер
                    //items.push({
                    //    type: 'container',
                    //    html: "<div class='alert alert-danger'>Тут должен быть пейджер</div>"
                    //});
                   
                });

  
            // Open window
            editor.windowManager.open({
                title: 'Галерея фотоальбомов',
                classes: 'modal-dialog modal-lg',
                //url: '/admin/photoalbums/api',
                body: [
                    {
                        type: 'container',
                        name: 'gallery',
                        id: 'mce-gallery-plugin',
                        minWidth: 900,
                        minHeight: 400,
                        style: "direction: ltr; text-align: left",
                        //html: '<h1>container<h1> is <i>ANY</i> html i guess...<br/><br/><pre>but needs some styling?!?</pre>'
                        items: items
                    }
                ],
                buttons: [
                //  {
                //    text: 'Insert',
                //    id: 'hd-fancybox-button-insert',
                //    onclick: function (e) {
                //        insertImg(editor);
                //        closeBox();
                //    },
                //},
                    {
                        text: 'Отмена',
                        id: 'gallery-plugin-item-cancel-btn',
                        onclick: 'close'
                    }],
                //onsubmit: function (e) {
                  
                //    // Insert content when the window form is submitted
                //    //editor.insertContent('Title: ' + e.data.title);
                   
                //}
            });
        }
    });

    // Adds a menu item to the tools menu
    editor.addMenuItem('gallery', {
        text: 'Галерея',
        context: 'tools',
        onclick: function () {
            // Open window with a specific url
            editor.windowManager.open({
                title: 'TinyMCE site',
                url: 'http://www.tinymce.com',
                width: 900,
                height: 600,
                buttons: [{
                    text: 'Close',
                    onclick: 'close'
                }]
            });
        }
    });
});